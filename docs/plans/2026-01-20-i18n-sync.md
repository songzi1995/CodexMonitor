# I18n Sync Automation Implementation Plan

> **REQUIRED SUB-SKILL:** Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Standardize upstream merge + i18n reuse with a repeatable script and checks so frequent updates are low-effort and low-risk.

**Architecture:** Keep `main` fast-forwarded to `upstream/main`, store localization on `i18n`, and merge via a temporary branch. Provide a small Node CLI (testable) with a thin shell wrapper for consistent update steps and post-merge checks.

**Tech Stack:** Node.js (built-in `node:test`), Git, existing npm scripts (`lint`, `typecheck`, `test:i18n`).

### Task 1: Document and Verify Branch Policy

**Files:**
- Modify: `AGENTS.md`

**Step 1: Write the failing test**

Create a verification checklist file (temporary) that asserts branch policy is documented and `git rerere` is enabled. This is a “process test” that should fail until the policy is written.

```bash
cat <<'TEST' > /tmp/i18n-policy-check.sh
set -e
rg -n "I18n Workflow Constraints" AGENTS.md >/dev/null
if git config --global rerere.enabled | rg -q "true"; then
  exit 0
fi
exit 1
TEST
bash /tmp/i18n-policy-check.sh
```

Expected: FAIL (missing section or rerere not enabled).

**Step 2: Run test to verify it fails**

Run: `bash /tmp/i18n-policy-check.sh`
Expected: exit code 1.

**Step 3: Write minimal implementation**

- Ensure `AGENTS.md` contains the I18n constraints section.
- Enable rerere: `git config --global rerere.enabled true`.

**Step 4: Run test to verify it passes**

Run: `bash /tmp/i18n-policy-check.sh`
Expected: exit code 0.

**Step 5: Commit**

```bash
git add AGENTS.md
git commit -m "docs: add i18n merge workflow constraints"
```

### Task 2: Add Testable I18n Sync CLI

**Files:**
- Create: `scripts/i18n-sync-lib.mjs`
- Create: `scripts/i18n-sync.mjs`
- Create: `scripts/i18n-sync.sh`
- Test: `scripts/__tests__/i18n-sync-lib.test.mjs`

**Step 1: Write the failing test**

```javascript
import test from "node:test";
import assert from "node:assert/strict";
import { buildMergeBranchName, buildVerifyCommands } from "../i18n-sync-lib.mjs";

test("buildMergeBranchName uses YYYYMMDD suffix", () => {
  assert.equal(buildMergeBranchName("2026-01-20"), "merge/upstream-20260120");
});

test("buildVerifyCommands returns lint -> typecheck -> test:i18n", () => {
  assert.deepEqual(buildVerifyCommands(), [
    "npm run lint",
    "npm run typecheck",
    "npm run test:i18n",
  ]);
});
```

**Step 2: Run test to verify it fails**

Run: `node --test scripts/__tests__/i18n-sync-lib.test.mjs`
Expected: FAIL with “module not found”.

**Step 3: Write minimal implementation**

`i18n-sync-lib.mjs` should export pure helpers used by the CLI. Keep it dependency-free.

```javascript
export function buildMergeBranchName(date) {
  return `merge/upstream-${date.replaceAll("-", "")}`;
}

export function buildVerifyCommands() {
  return ["npm run lint", "npm run typecheck", "npm run test:i18n"];
}
```

`i18n-sync.mjs` should:
- validate clean working tree
- fast-forward `main` to `upstream/main`
- create temp merge branch from `i18n`
- merge `main` into temp branch
- optionally run verify commands

`scripts/i18n-sync.sh` should be a thin wrapper:

```bash
#!/usr/bin/env bash
node scripts/i18n-sync.mjs "$@"
```

**Step 4: Run test to verify it passes**

Run: `node --test scripts/__tests__/i18n-sync-lib.test.mjs`
Expected: PASS.

**Step 5: Commit**

```bash
git add scripts/i18n-sync-lib.mjs scripts/i18n-sync.mjs scripts/i18n-sync.sh scripts/__tests__/i18n-sync-lib.test.mjs
git commit -m "feat: add i18n sync helper scripts"
```

### Task 3: Add I18n Literal Scan Report

**Files:**
- Create: `scripts/i18n-scan.mjs`
- Test: `scripts/__tests__/i18n-scan.test.mjs`

**Step 1: Write the failing test**

```javascript
import test from "node:test";
import assert from "node:assert/strict";
import { detectLiteralStrings } from "../i18n-scan.mjs";

test("detectLiteralStrings finds JSX text nodes", () => {
  const input = "<div>Hello</div>";
  assert.ok(detectLiteralStrings(input).length > 0);
});
```

**Step 2: Run test to verify it fails**

Run: `node --test scripts/__tests__/i18n-scan.test.mjs`
Expected: FAIL with “module not found”.

**Step 3: Write minimal implementation**

Implement a conservative scanner that:
- searches `src/**/*.tsx` for obvious JSX text nodes and string literals
- outputs a report (file path + snippet)
- ignores already translated `t("...")` calls

**Step 4: Run test to verify it passes**

Run: `node --test scripts/__tests__/i18n-scan.test.mjs`
Expected: PASS.

**Step 5: Commit**

```bash
git add scripts/i18n-scan.mjs scripts/__tests__/i18n-scan.test.mjs
git commit -m "feat: add i18n literal scan report"
```

### Task 4: Wire CLI to Project Docs

**Files:**
- Modify: `README.md`

**Step 1: Write the failing test**

Create a temporary check that fails until README references the sync script.

```bash
cat <<'TEST' > /tmp/i18n-readme-check.sh
set -e
rg -n "i18n-sync" README.md >/dev/null
TEST
bash /tmp/i18n-readme-check.sh
```

Expected: FAIL.

**Step 2: Run test to verify it fails**

Run: `bash /tmp/i18n-readme-check.sh`
Expected: exit code 1.

**Step 3: Write minimal implementation**

Add a short “I18n sync workflow” section to README referencing `scripts/i18n-sync.sh` and the branch model.

**Step 4: Run test to verify it passes**

Run: `bash /tmp/i18n-readme-check.sh`
Expected: exit code 0.

**Step 5: Commit**

```bash
git add README.md
git commit -m "docs: document i18n sync workflow"
```
